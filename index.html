<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Domain Info Lookup</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f9f9f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        h1, h3 { color: #333; }
        table { background-color: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        th { background-color: #e8f0fe; color: #333; }
        .badge-soft { background-color: #d0ebff; color: #007bff; font-weight: 500; }
        .badge-success-soft { background-color: #d4edda; color: #28a745; font-weight: 500; }
        .badge-warning-soft { background-color: #fff3cd; color: #856404; font-weight: 500; }
        input, button { border-radius: 8px; }
        .container { max-width: 950px; }
    </style>
</head>
<body>

<div class="container my-5">
    <h1 class="mb-4">üîé Domain Info Lookup</h1>

    <!-- Input -->
    <div class="input-group mb-4">
        <input id="domainInput" type="text" class="form-control" placeholder="Enter domains separated by commas e.g. google.com, yahoo.com">
        <button id="fetchBtn" class="btn btn-primary">Fetch Info</button>
    </div>

    <!-- Download All CSV -->
    <div class="mb-4">
        <button id="downloadAll" class="btn btn-success">Download All CSV</button>
    </div>

    <!-- Domain Stats -->
    <h3>üåç Domain Stats</h3>
    <div class="table-responsive mb-4">
        <table id="statsTable" class="table table-hover">
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Price</th>
                    <th>DR</th>
                    <th>RefDomains</th>
                    <th>Backlinks</th>
                    <th>Traffic</th>
                    <th>Country</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Resellers -->
    <h3>üíº Resellers</h3>
    <div class="table-responsive mb-4">
        <table id="resellerTable" class="table table-hover">
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Contact</th>
                    <th>Price</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const fetchBtn = document.getElementById("fetchBtn");
const statsBody = document.querySelector("#statsTable tbody");
const resellerBody = document.querySelector("#resellerTable tbody");
const downloadAllBtn = document.getElementById("downloadAll");

let lastStatsData = [];
let lastResellerData = [];

// --- Fetch Data ---
fetchBtn.addEventListener("click", async () => {
    const input = document.getElementById("domainInput").value.trim();
    if (!input) return alert("Enter at least one domain!");

    const domains = input.split(",").map(d => d.trim()).filter(Boolean);
    if (!domains.length) return alert("Enter valid domains!");

    statsBody.innerHTML = `<tr><td colspan="7" class="text-center">Fetching...</td></tr>`;
    resellerBody.innerHTML = `<tr><td colspan="4" class="text-center">Fetching...</td></tr>`;

    lastStatsData = [];
    lastResellerData = [];

    try {
        for (let domain of domains) {
            const res = await fetch(`https://bot-8-1-i9y3.onrender.com/fetch?domain=${encodeURIComponent(domain)}`);
            const data = await res.json();

            // --- Domain Stats ---
            if (data.domain_stats && data.domain_stats.length) {
                data.domain_stats.forEach(d => lastStatsData.push(d));
            }

            // --- Resellers ---
            if (data.resellers && data.resellers.length) {
                data.resellers.forEach(d => lastResellerData.push(d));
            }
        }

        // Populate tables
        populateTable(statsBody, lastStatsData, 7, true);
        populateTable(resellerBody, lastResellerData, 4, false);

    } catch(err) {
        console.error(err);
        statsBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Failed to fetch backend</td></tr>`;
        resellerBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Failed to fetch backend</td></tr>`;
    }
});

// --- Populate Table Function ---
function populateTable(tbody, data, cols, isStats) {
    tbody.innerHTML = "";
    if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="${cols}" class="text-center">No data found</td></tr>`;
        return;
    }
    data.forEach(d => {
        if (isStats) {
            const priceBadge = d.Price ? `<span class="badge badge-success-soft">${d.Price}</span>` : "-";
            const trafficBadge = d.Traffic ? `<span class="badge badge-soft">${d.Traffic}</span>` : "-";
            const row = `<tr>
                <td>${d.Domain || '-'}</td>
                <td>${priceBadge}</td>
                <td>${d.DR || '-'}</td>
                <td>${d.RefDomains || '-'}</td>
                <td>${d.Backlinks || '-'}</td>
                <td>${trafficBadge}</td>
                <td>${d.Country || '-'}</td>
            </tr>`;
            tbody.innerHTML += row;
        } else {
            const priceBadge = d.Price ? `<span class="badge badge-success-soft">${d.Price}</span>` : "-";
            const row = `<tr>
                <td>${d.Domain || '-'}</td>
                <td>${d.Contact || '-'}</td>
                <td>${priceBadge}</td>
                <td>${d.Date || '-'}</td>
            </tr>`;
            tbody.innerHTML += row;
        }
    });
}

// --- Download All CSV ---
downloadAllBtn.addEventListener("click", () => {
    if (!lastStatsData.length && !lastResellerData.length) return alert("No data to download!");

    let csvContent = "";

    // Domain Stats Section
    if (lastStatsData.length) {
        csvContent += "Domain Stats\n";
        const headers = Object.keys(lastStatsData[0]);
        csvContent += headers.join(",") + "\n";
        lastStatsData.forEach(row => {
            const values = headers.map(h => `"${(row[h] ?? "").toString().replace(/"/g,'""')}"`);
            csvContent += values.join(",") + "\n";
        });
        csvContent += "\n";
    }

    // Resellers Section
    if (lastResellerData.length) {
        csvContent += "Resellers\n";
        const headers = Object.keys(lastResellerData[0]);
        csvContent += headers.join(",") + "\n";
        lastResellerData.forEach(row => {
            const values = headers.map(h => `"${(row[h] ?? "").toString().replace(/"/g,'""')}"`);
            csvContent += values.join(",") + "\n";
        });
    }

    // Download
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "domain_data.csv";
    a.click();
    URL.revokeObjectURL(url);
});
</script>

</body>
</html>
